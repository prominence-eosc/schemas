openapi: 3.0.0
servers: []
info:
  description: |
    This is the specification of the PROMINENCE REST API.
    This is still considered a work in progress, so things could change or break with every update.
  version: 1.0.0
  title: PROMINENCE REST API 
  
tags:
  - name: jobs
    description: The Jobs API endpoint is for managing jobs
  - name: workflows
    description: The Workflows API endpoint is for managing workflows
  - name: data
    description: The Data API endpoint is for managing data
    
paths:
  /jobs:
    post:
      tags:
        - jobs
      summary: Create a job
      responses:
        '201':
          description: Success       
        '400':
          description: Invalid input     
        '401':
          description: Authentication failure
      security:
        - jobs_auth:
            - 'write:jobs'
            - 'read:jobs'
      requestBody:
        $ref: '#/components/requestBodies/Job'
    get:
      tags:
        - jobs
      summary: List jobs
      description: Returns a list of jobs
      responses:
        '200':
          description: successful operation
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Job'
        '400':
          description: Invalid ID supplied
        '401':
          description: Authentication failure
        '404':
          description: Job not found
      security:
        - api_key: []        
  '/jobs/{id}':
    get:
      tags:
        - jobs
      summary: Describe a job
      description: Describe a job
      parameters:
        - name: id
          in: path
          description: ID of job to return
          required: true
          schema:
            type: integer
            format: int64
      responses:
        '200':
          description: successful operation
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Job'
        '400':
          description: Invalid ID supplied
        '401':
          description: Authentication failure
        '404':
          description: Job not found
      security:
        - api_key: []
    delete:
      tags:
        - jobs
      summary: Deletes a job
      parameters:
        - name: api_key
          in: header
          required: false
          schema:
            type: string
        - name: id
          in: path
          description: Job id to delete
          required: true
          schema:
            type: integer
            format: int64
      responses:
        '200':
          description: Success     
        '400':
          description: Invalid ID supplied
        '401':
          description: Authentication failure   
        '404':
          description: Job not found
      security:
        - petstore_auth:
            - 'write:jobs'
            - 'read:jobs'        
  '/jobs/{id}/stdout':
    get:
      tags:
        - jobs
      summary: Get standard output from a job
      description: Get standard output from a job
      parameters:
        - name: id
          in: path
          description: ID of job to return
          required: true
          schema:
            type: integer
            format: int64
      responses:
        '200':
          description: successful operation
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Job'
        '400':
          description: Job does not exist
        '401':
          description: Authentication failure
        '403':
          description: Not authorised to access this job       
        '404':
          description: Standard output does not exist
      security:
        - api_key: []      
  '/jobs/{id}/stderr':
    get:
      tags:
        - jobs
      summary: Get standard error from a job
      description: Get standard error from a job
      parameters:
        - name: id
          in: path
          description: ID of job to return
          required: true
          schema:
            type: integer
            format: int64
      responses:
        '200':
          description: successful operation
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Job'
        '400':
          description: Job does not exist
        '401':
          description: Authentication failure
        '403':
          description: Not authorised to access this job       
        '404':
          description: Standard output does not exist
      security:
        - api_key: []             
  '/workflows':
    post:
      tags:
        - workflows
      summary: Create workflow
      description: Create workflow
      parameters:
        - name: id
          in: path
          description: ID of job to return
          required: true
          schema:
            type: integer
            format: int64      
      responses:
        default:
          description: successful operation
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Workflow'
        description: Created user object
        required: true
    get:
      tags:
        - workflows
      summary: List workflows
      parameters:
        - name: username
          in: path
          description: The name that needs to be fetched. Use user1 for testing.
          required: true
          schema:
            type: string
      responses:
        '200':
          description: successful operation
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Workflow'
        '400':
          description: Invalid username supplied
        '401':
          description: Authentication failure   
        '404':
          description: User not found        
  '/workflows/{id}':
    get:
      tags:
        - workflows
      summary: Describes a workflow
      parameters:
        - name: username
          in: path
          description: The name that needs to be fetched. Use user1 for testing.
          required: true
          schema:
            type: string
        - name: id
          in: path
          description: ID of job to return
          required: true
          schema:
            type: integer
            format: int64            
      responses:
        '200':
          description: successful operation
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Workflow'
        '400':
          description: Invalid username supplied
        '401':
          description: Authentication failure   
        '404':
          description: User not found
    delete:
      tags:
        - workflows
      summary: Delete a workflow
      description: This can only be done by the logged in user.
      parameters:
        - name: username
          in: path
          description: The name that needs to be deleted
          required: true
          schema:
            type: string
        - name: id
          in: path
          description: ID of job to return
          required: true
          schema:
            type: integer
            format: int64               
      responses:
        '400':
          description: Invalid username supplied
        '401':
          description: Authentication failure   
        '404':
          description: User not found
  '/data/upload':
    post:
      tags:
        - data
      summary: Obtain a presigned URL 
      responses:
        '401':
          description: Authentication failure      
        '405':
          description: Invalid input
      security:
        - jobs_auth:
            - 'write:jobs'
            - 'read:jobs'
      requestBody:
        $ref: '#/components/requestBodies/Job'          
externalDocs:
  description: Find out more about PROMINENCE
  url: 'https://prominence-eosc.github.io/docs'
components:
  schemas:
    Job:
      type: object
      properties:
        name:
          type: string
          description: Job name
        resources:
          type: Resources
          description: Requested resources
        tasks:
          type: string
          description: List of tasks
        storage:
          type: Storage
          description: Requested storage          
      xml:
        name: Job 
    Resources:
      type: object
      properties:
        cpus:
          type: integer
          format: int32
          description: Requested number of CPUs
        memory:
          type: integer
          format: int32
          description: Requested memory in GB
        disk:
          type: integer
          format: int32
          description: Requested local disk in GB
        nodes:
          type: string
          format: int32
          description: Requested number of nodes
      xml:
        name: Resources
    Task:
      type: object
      properties:
        image:
          type: string
          description: Container image
        runtime:
          type: string
          description: Container runtime
          enum:
            - singularity
            - udocker
        cmd:
          type: string
          description: Command to execute
        workdir:
          type: string
          description: Current working directory
        type:
          type: string
          description: Task type
          enum:
            - basic
            - openmpi
            - mpich
      xml:
        name: Task
    Storage:
      type: object
      properties:
        type:
          type: string
          description: Storage type
          enum:
            - b2drop
            - onedata
        mountpoint:
          type: string
          description: Mountpoint inside container
      xml:
        name: Storage
